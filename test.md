# alluxio 回归测试用例

## 约定：

### 前置条件

1. 已知 avatest 账号的 ak/sk，且已经使用 avatest 账号登录 qrsctl
2. 在 avatest 账号的 bucket alluxio-test 中，已经包含 folder_1w 文件夹且其中有 10000 个文件
3. 在 avatest 账号的 bucket alluxio-test 中，已经有多个文件和文件夹
4. 下面的操作皆在 alluxio-proxy 下执行，若程序运行在容器中，容器启动时需要 priviledge 权限

### 参数

ava_test_ak: avatest 账号的 ak
ava_test_sk: avatest 账号的 sk

### 回归等级

1. P0 很重要，每次上线前都要验证，如果无法通过，必须以 hotfix 修复
2. P1 重要，每次上线前都要验证，如果无法通过，必须修复完才能上线
3. P2 一般，每次有重要改动都要验证，如果无法通过，需要酌情考虑是否发布
4. P3 可有可无，alluxio 版本升级时需要验证，如果无法通过，需要酌情考虑是否推迟更新

## 回归用例列表

### 1. mount 相关

| 序号 | 操作                                                   | 命令                                                                                                                                                                                                                                                                                                                          | 预期结果    | 回归等级 |
|------|--------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------|----------|
| 1    | 第一次在 alluxio 中创建路径                            | /opt/alluxio/bin/alluxio fs mkdir /a/b/1381351869 /a/b/1381102889                                                                                                                                                                                                                                                             | 创建成      | P0       |
| 2    | 再次在 alluxio 中创建路径                              | /opt/alluxio/bin/alluxio fs mkdir /a/b/1381351869                                                                                                                                                                                                                                                                             | 创建失败    | P0       |
| 3    | 在 alluxio 中正常的 mount bucket 挂载点                | /opt/alluxio/bin/alluxio fs mount --option fs.oss.accessKeyId=\<ava\_test\_ak\> --option fs.oss.accessKeySecret=\<ava\_test\_sk\> --option fs.oss.userId=1381351869 --option fs.oss.endpoint=p8pmpcuqj.bkt.clouddn.com /a/b/1381351869/alluxio-test oss://alluxio-test          | mount 成功  | P0       |
| 4    | 在 alluxio 中正常的 mount bucket 挂载点                | /opt/alluxio/bin/alluxio fs mount --option fs.oss.accessKeyId=\<ava\_test\_ak\> --option fs.oss.accessKeySecret=\<ava\_test\_sk\> --option fs.oss.userId=1381102889 --option fs.oss.endpoint=p8pmpcuqj.bkt.clouddn.com /a/b/1381102889/alluxio-test oss://alluxio-test          | mount 成功  | P0       |
| 5    | 在 alluxio 中 mount 重复的 bucket 挂载点(挂载路径重复) | /opt/alluxio/bin/alluxio fs mount --option fs.oss.accessKeyId=\<ava\_test\_ak\> --option fs.oss.accessKeySecret=\<ava\_test\_sk\> --option fs.oss.userId=1381102889 --option fs.oss.endpoint=p8pmpcuqj.bkt.clouddn.com /a/b/1381102889/alluxio-test oss://alluxio-test          | mount 失败  | P0       |
| 6    | 在 alluxio 中 mount bucket 挂载点到不存在的路径        | /opt/alluxio/bin/alluxio fs mount --option fs.oss.accessKeyId=\<ava\_test\_ak\> --option fs.oss.accessKeySecret=\<ava\_test\_sk\> --option fs.oss.userId=111111 --option fs.oss.endpoint=p8pmpcuqj.bkt.clouddn.com /a/b/not_exists_path/alluxio-test oss://alluxio-test         | mount 失败  | P1       |
| 7    | 在 alluxio 中 mount bucket 挂载点(bucket相同)          | /opt/alluxio/bin/alluxio fs mount --option fs.oss.accessKeyId=\<ava\_test\_ak\> --option fs.oss.accessKeySecret=\<ava\_test\_sk\> --option fs.oss.userId=1381102889 --option fs.oss.endpoint=p8pmpcuqj.bkt.clouddn.com /a/b/repeate_underfs_uri/alluxio-test oss://alluxio-test | mount 失败  | P1       |
| 8    | unmount 之前挂载的 mountpoint                          | /opt/alluxio/bin/alluxio fs unmount /a/b/1381351869/alluxio-test                                                                                                                                                                                                                                                              | umonut 成功 | P2       |
| 9    | unmount 不存在的挂载点                                 | /opt/alluxio/bin/alluxio fs unmount /a/b/not_exists_path/alluxio-test                                                                                                                                                                                                                                                         | umount 失败 | P2       |
| 10   | 使用 fuse mount bucket 到本地路径                      | rm -rf /test-alluxio-fuse && mkdir -p /test-alluxio-fuse && /opt/alluxio/integration/fuse/bin/alluxio-fuse mount /test-alluxio-fuse /a/b/1381102889/alluxio-test                                                                                                                                                                    | 成功        | P1       |
| 11   | umount 上一条 mount 的本地文件系统                     | /opt/alluxio/integration/fuse/bin/alluxio-fuse umount /test-alluxio-fuse                                                                                                                                                                                                                                                           | 成功        | P2       |

### 2. 文件操作

| 序号 | 操作                                                                                                                  | 命令                                                                                                                                                                                                                                                                                                                  | 预期结果                                        | 回归等级 |
|------|-----------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------|----------|
| 1    | 列出文件夹中的文件列表                                                                                                | /opt/alluxio/bin/alluxio fs ls /a/b/1381102889/alluxio-test                                                                                                                                                                                                                                                           | 列出多个文件                                    | P0       |
| 2    | 列一个不存在的文件夹                                                                                                  | /opt/alluxio/bin/alluxio fs ls /a/b/1381102889/alluxio-test/path_not_exists                                                                                                                                                                                                                                           | 报路径不存在的错误                              | P1       |
| 3    | 查看 kodo 中文本文件的内容                                                                                            | /opt/alluxio/bin/alluxio fs cat /a/b/1381102889/alluxio-test/hello                                                                                                                                                                                                                                                    | 显示文件内容                                    | P0       |
| 4    | 修改文件名                                                                                                            | /opt/alluxio/bin/alluxio fs mv /a/b/1381102889/alluxio-test/source /a/b/1381102889/alluxio-test/target && /opt/alluxio/bin/alluxio fs mv /a/b/1381102889/alluxio-test/target /a/b/1381102889/alluxio-test/source                                                                                                      | 操作成功                                        | P1       |
| 5    | 在成功执行了 1.10 操作之后，写入文件到 alluxio 中                                                                      | echo "test-alluxio-fuse-write" > /test-alluxio-fuse/test-write                                                                                                                                                                                                                                                        | 写入成功                                        | P1       |
| 6    | 在成功执行了 2.5 操作之后，删除文件                                                                                    | rm /test-alluxio-fuse/test-write                                                                                                                                                                                                                                                                                      | 成功删除                                        | P1       |
| 7    | 在成功执行了 1.10 操作之后，写入大文件到 alluxio 中                                                                    | dd if=/dev/urandom of=/test-alluxio-fuse/test-write-2G bs=4M count=512                                                                                                                                                                                                                                                     | 写入成功                                        | P2       |
| 8    | 在成功执行了 2.7 操作之后，读取大文件                                                                                  | dd if=/test-alluxio-fuse/test-write-2G of=/dev/null bs=4M                                                                                                                                                                                                                                                                  | 读取成功                                        | P2       |
| 9    | 在成功执行了 1.10 操作之后，先 ls 一下 bucket 指定路径，接着通过其他途径修改 bucket 的文件，然后再次 ls 查看文件的元信息 | mkdir -p /tmp/ && dd if=/dev/urandom of=/tmp/1m bs=1M count=1 && qrsctl put alluxio-test test-ls/1 /tmp/1m && echo "first time" && ls -lh /test-alluxio-fuse/test-ls/1 && dd if=/dev/urandom of=/tmp/4m bs=1M count=4 && qrsctl put alluxio-test test-ls/1 /tmp/4m && echo "second time" && ls -lh /test-alluxio-fuse/test-ls/1 | 第一次显示文件大小为 1m，第二次显示文件大小为 4m | P2       |
| 10   | 在成功执行了 1.10 操作之后，尝试 ls 含有超过 5000 个文件的文件夹                                                       | ls -l /test-alluxio-fuse/folder_1w                                                                                                                                                                                                                                                                                         | 列出 10000 个文件                               | P2       |
